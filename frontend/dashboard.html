<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hesabım</title>

  <link rel="stylesheet" href="dashboard.css">


</head>

<body>
  <div class="container">
    <div class="header">
      <h1>📊 Hesabım</h1>
    </div>

    <div class="profile-card">
      <div class="profile-content">
        <div class="profile-photo-section">
          <div class="profile-photo-wrapper">
            <img id="profilePhoto" class="profile-photo"
              src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23ddd'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' font-size='40' fill='%23999'%3E👤%3C/text%3E%3C/svg%3E"
              alt="Profile">
            <label class="upload-overlay" for="photoInput"></label>
            <input type="file" id="photoInput" accept="image/*">
          </div>
        </div>

        <div class="profile-info">
          <div id="userContent" class="loading">
            Yükleniyor...
          </div>
        </div>
      </div>
    </div>

    <div id="usersSection" class="users-card" style="display: none;">
      <div class="users-header">
        <h2>👥 Tüm Kullanıcılar</h2>
        <span class="user-count" id="userCount">0 Kullanıcı</span>
      </div>
      <div id="allUsers" class="loading">
        Yükleniyor...
      </div>
    </div>
  </div>

  <!-- Crop Modal -->
  <div id="cropModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>📷 Fotoğrafı Düzenle</h2>
        <button class="close-modal" onclick="closeCropModal()">×</button>
      </div>

      <div class="crop-container" id="cropContainer">
        <canvas id="cropCanvas" class="crop-canvas"></canvas>
        <div class="crop-overlay"></div>
      </div>

      <div class="zoom-controls">
        <label>🔍 Yakınlaştır:</label>
        <input type="range" id="zoomSlider" class="zoom-slider" min="1" max="3" step="0.01" value="1">
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeCropModal()">İptal</button>
        <button class="btn btn-primary" onclick="saveCroppedPhoto()">💾 Kaydet</button>
      </div>
    </div>
  </div>

  <script>
    const userId = localStorage.getItem('userId');
    const isAdmin = localStorage.getItem('isAdmin') === 'true';

    let currentImage = null;
    let imageX = 0;
    let imageY = 0;
    let imageScale = 1;
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;

    if (!userId) {
      window.location.href = '/login';
    }

    async function loadUserInfo() {
      try {
        const res = await fetch(`http://localhost:3000/user/${userId}`);
        const user = await res.json();

        if (res.ok) {
          if (user.profile_photo) {
            document.getElementById('profilePhoto').src = user.profile_photo;
          }

          document.getElementById('userContent').innerHTML = `
            <h2 class="profile-name">${user.username}</h2>
            <p class="profile-email">${user.email}</p>
            ${user.is_admin ? '<span class="admin-badge">👑 Admin</span>' : ''}
            
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Kullanıcı ID</div>
                <div class="info-value">#${user.id}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Kayıt Tarihi</div>
                <div class="info-value">${new Date(user.created_at).toLocaleDateString('tr-TR')}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Hesap Durumu</div>
                <div class="info-value">✅ Aktif</div>
              </div>
              <div class="info-item">
                <div class="info-label">Yetki Seviyesi</div>
                <div class="info-value">${user.is_admin ? '👑 Admin' : '👤 Kullanıcı'}</div>
              </div>
            </div>
            
            <div class="actions">
              <button class="btn btn-danger" onclick="logout()">🚪 Çıkış Yap</button>
            </div>
          `;

          if (user.is_admin) {
            document.getElementById('usersSection').style.display = 'block';
            loadAllUsers();
          }
        } else {
          document.getElementById('userContent').innerHTML = `
            <div class="error-message">Kullanıcı bilgileri yüklenemedi</div>
            <div class="actions">
              <button class="btn btn-danger" onclick="logout()">🚪 Çıkış Yap</button>
            </div>
          `;
        }
      } catch (error) {
        document.getElementById('userContent').innerHTML = `
          <div class="error-message">Sunucuya bağlanılamadı</div>
          <div class="actions">
            <button class="btn btn-danger" onclick="logout()">🚪 Çıkış Yap</button>
          </div>
        `;
      }
    }

    async function loadAllUsers() {
      try {
        const res = await fetch(`http://localhost:3000/users?requesterId=${userId}`);

        if (res.status === 403) {
          document.getElementById('allUsers').innerHTML = '<div class="error-message">Bu sayfayı görüntülemek için admin yetkisi gerekli</div>';
          return;
        }

        const users = await res.json();

        if (res.ok && users.length > 0) {
          document.getElementById('userCount').textContent = `${users.length} Kullanıcı`;

          let html = `
            <table>
              <thead>
                <tr>
                  <th>Profil</th>
                  <th>Kullanıcı Adı</th>
                  <th>Email</th>
                  <th>Kayıt Tarihi</th>
                  <th>Yetki</th>
                  <th>İşlem</th>
                </tr>
              </thead>
              <tbody>
          `;

          users.forEach(user => {
            const isCurrentUser = user.id == userId;
            const photoSrc = user.profile_photo || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23ddd'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' font-size='40' fill='%23999'%3E👤%3C/text%3E%3C/svg%3E";

            html += `
              <tr style="${isCurrentUser ? 'background: #e7f3ff;' : ''}">
                <td><img src="${photoSrc}" class="user-avatar" alt="${user.username}"></td>
                <td><strong>${user.username}</strong></td>
                <td>${user.email}</td>
                <td>${new Date(user.created_at).toLocaleDateString('tr-TR')}</td>
                <td>
                  ${user.is_admin ? '<span class="badge badge-admin">Admin</span>' : '<span class="badge">Kullanıcı</span>'}
                  ${isCurrentUser ? '<span class="badge">Siz</span>' : ''}
                </td>
                <td>
                  ${!isCurrentUser ? `<button class="delete-btn" onclick="deleteUser(${user.id})">🗑️ Sil</button>` : '-'}
                </td>
              </tr>
            `;
          });

          html += `</tbody></table>`;
          document.getElementById('allUsers').innerHTML = html;
        } else {
          document.getElementById('allUsers').innerHTML = '<p>Henüz kullanıcı yok</p>';
        }
      } catch (error) {
        document.getElementById('allUsers').innerHTML = '<div class="error-message">Kullanıcılar yüklenemedi</div>';
      }
    }

    document.getElementById('photoInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (file.size > 5 * 1024 * 1024) {
        alert('Dosya boyutu 5MB\'dan küçük olmalı');
        return;
      }

      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          currentImage = img;
          openCropModal();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);

      e.target.value = '';
    });

    function openCropModal() {
      const modal = document.getElementById('cropModal');
      const canvas = document.getElementById('cropCanvas');
      const ctx = canvas.getContext('2d');
      const container = document.getElementById('cropContainer');

      const containerSize = 400;
      canvas.width = containerSize;
      canvas.height = containerSize;

      const scale = Math.max(containerSize / currentImage.width, containerSize / currentImage.height);
      imageScale = scale;
      imageX = (containerSize - currentImage.width * scale) / 2;
      imageY = (containerSize - currentImage.height * scale) / 2;

      document.getElementById('zoomSlider').value = 1;

      modal.style.display = 'block';
      drawImage();
      setupCropControls();
    }

    function closeCropModal() {
      document.getElementById('cropModal').style.display = 'none';
      currentImage = null;
    }

    function drawImage() {
      const canvas = document.getElementById('cropCanvas');
      const ctx = canvas.getContext('2d');

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.drawImage(
        currentImage,
        imageX,
        imageY,
        currentImage.width * imageScale,
        currentImage.height * imageScale
      );
      ctx.restore();
    }

    function setupCropControls() {
      const canvas = document.getElementById('cropCanvas');
      const zoomSlider = document.getElementById('zoomSlider');

      canvas.onmousedown = (e) => {
        isDragging = true;
        const rect = canvas.getBoundingClientRect();
        dragStartX = e.clientX - rect.left - imageX;
        dragStartY = e.clientY - rect.top - imageY;
      };

      canvas.onmousemove = (e) => {
        if (!isDragging) return;
        const rect = canvas.getBoundingClientRect();
        imageX = e.clientX - rect.left - dragStartX;
        imageY = e.clientY - rect.top - dragStartY;
        drawImage();
      };

      canvas.onmouseup = () => {
        isDragging = false;
      };

      canvas.onmouseleave = () => {
        isDragging = false;
      };

      zoomSlider.oninput = (e) => {
        const containerSize = 400;
        const baseScale = Math.max(containerSize / currentImage.width, containerSize / currentImage.height);
        const zoomFactor = parseFloat(e.target.value);
        const newScale = baseScale * zoomFactor;

        // Canvas'ın merkez noktası
        const centerX = containerSize / 2;
        const centerY = containerSize / 2;

        // Eski ölçekte merkezin fotoğraf üzerindeki konumu
        const imageCenterX = (centerX - imageX) / imageScale;
        const imageCenterY = (centerY - imageY) / imageScale;

        // Yeni ölçeği uygula
        imageScale = newScale;

        // Yeni ölçekte aynı nokta merkeze gelecek şekilde konumu ayarla
        imageX = centerX - (imageCenterX * imageScale);
        imageY = centerY - (imageCenterY * imageScale);

        drawImage();
      };
    }

    async function saveCroppedPhoto() {
      const canvas = document.getElementById('cropCanvas');
      const outputCanvas = document.createElement('canvas');
      const ctx = outputCanvas.getContext('2d');

      const size = 300;
      outputCanvas.width = size;
      outputCanvas.height = size;

      const containerSize = 400;
      const cropSize = 300;
      const cropX = (containerSize - cropSize) / 2;
      const cropY = (containerSize - cropSize) / 2;

      ctx.drawImage(
        canvas,
        cropX, cropY, cropSize, cropSize,
        0, 0, size, size
      );

      const photoUrl = outputCanvas.toDataURL('image/jpeg', 0.9);

      try {
        const res = await fetch(`http://localhost:3000/user/${userId}/photo`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ photoUrl })
        });

        if (res.ok) {
          document.getElementById('profilePhoto').src = photoUrl;
          if (isAdmin) loadAllUsers();
          closeCropModal();
          alert('✅ Profil fotoğrafı başarıyla güncellendi!');
        } else {
          alert('❌ Fotoğraf yüklenemedi');
        }
      } catch (error) {
        alert('❌ Sunucuya bağlanılamadı');
      }
    }

    async function deleteUser(deleteUserId) {
      if (!confirm('Bu kullanıcıyı silmek istediğinize emin misiniz?')) {
        return;
      }

      try {
        const res = await fetch(`http://localhost:3000/user/${deleteUserId}?requesterId=${userId}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          alert('Kullanıcı başarıyla silindi');
          loadAllUsers();
        } else {
          const data = await res.json();
          alert(data.error || 'Kullanıcı silinemedi');
        }
      } catch (error) {
        alert('Sunucuya bağlanılamadı');
      }
    }

    function logout() {
      localStorage.removeItem('userId');
      localStorage.removeItem('isAdmin');
      window.location.href = '/login';
    }

    loadUserInfo();
  </script>
</body>

</html>